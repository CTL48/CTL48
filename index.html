<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>CTL48 Official App</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

  <style>
    /* (CSS Global) */
    :root { --primary: #e91e63; --primary-soft: #fce4ec; --dark: #333333; --text-gray: #666666; --bg: #fafafa; --white: #ffffff; }
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { background-color: var(--bg); color: var(--dark); font-family: 'Roboto', sans-serif; padding-bottom: 90px; overflow-x: hidden; }
    
    /* Header & Hero */
    .header { background: rgba(255, 255, 255, 0.95); padding: 15px; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 20px rgba(233, 30, 99, 0.1); text-align: center; backdrop-filter: blur(10px); }
    .logo { font-family: 'Montserrat', sans-serif; font-weight: 900; font-size: 1.5rem; color: var(--primary); letter-spacing: 2px; }
    .hero { position: relative; height: 340px; color: white; display: flex; flex-direction: column; justify-content: flex-end; padding: 25px; overflow: hidden; margin-bottom: 20px; border-radius: 0 0 30px 30px; box-shadow: 0 10px 30px rgba(233, 30, 99, 0.2); }
    .hero-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -1; filter: brightness(0.6); }
    .hero-tag { background: var(--primary); width: fit-content; padding: 6px 14px; font-size: 0.7rem; font-weight: 900; border-radius: 50px; margin-bottom: 10px; letter-spacing: 1px; text-transform: uppercase; }
    .hero-title { font-family: 'Montserrat', sans-serif; font-size: 2rem; font-weight: 900; line-height: 1.1; margin-bottom: 5px; text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5); }
    .hero-sub { font-size: 0.9rem; opacity: 0.9; font-weight: 500; }
    
    /* Layout Basics */
    .container { padding: 10px 20px; }
    .section-title { font-family: 'Montserrat'; font-weight: 900; font-size: 1.3rem; margin: 20px 0; color: var(--dark); display: flex; align-items: center; }
    .section-title::before { content: ''; display: block; width: 6px; height: 24px; background: var(--primary); margin-right: 10px; border-radius: 10px; }
    .view-section { display: none; animation: fadeIn 0.4s cubic-bezier(0.25, 1, 0.5, 1); min-height: calc(100vh - 165px); }
    .view-section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
    
    /* News */
    .news-item { display: flex; gap: 15px; margin-bottom: 15px; background: white; padding: 15px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.03); }
    .news-date { font-weight: 700; color: #ccc; font-size: 0.7rem; min-width: 50px; text-align: center; line-height: 1.1; display: flex; flex-direction: column; justify-content: center; }
    .news-date span { display: block; font-size: 1.6rem; color: var(--primary); font-weight: 900; }
    .news-content h4 { font-size: 1rem; margin-bottom: 5px; line-height: 1.3; font-weight: 800; color: var(--dark); }
    .news-tag { font-size: 0.65rem; font-weight: 800; color: var(--primary); background: var(--primary-soft); padding: 3px 10px; border-radius: 10px; display: inline-block; margin-bottom: 6px; text-transform: uppercase; }
    .news-text { font-size: 0.85rem; color: var(--text-gray); line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    
    /* Discography */
    .discography-container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .single-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
    .single-card { position: relative; background: #fff; border-radius: 18px; overflow: hidden; cursor: pointer; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.06); transition: transform .2s ease; }
    .single-card:active { transform: scale(0.96); }
    .single-cover img { width: 100%; aspect-ratio: 1/1; object-fit: cover; display: block; }
    .single-info { padding: 12px; background: white; text-align: center; }
    .single-title-text { font-weight: 800; font-size: 0.9rem; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .single-type-text { font-size: 0.7rem; color: var(--primary); font-weight: 600; text-transform: uppercase; }
    
    /* Member List */
    .filter-bar { display: flex; gap: 10px; margin-bottom: 20px; }
    .filter-btn { flex: 1; padding: 10px; border-radius: 10px; border: 1px solid #eee; background: #fff; font-weight: 700; color: #777; font-size: 0.8rem; cursor: pointer; transition: 0.2s; }
    .filter-btn.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 10px rgba(233, 30, 99, 0.3); }
    #scroll-buttons { display: flex; gap: 8px; overflow-x: auto; padding: 5px; margin-bottom: 20px; -webkit-overflow-scrolling: touch; }
    #scroll-buttons::-webkit-scrollbar { display: none; }
    .button-gen { white-space: nowrap; padding: 10px 20px; border-radius: 50px; border: 1px solid #eee; background: white; color: #777; font-size: 0.85rem; font-weight: 700; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.03); transition: all 0.2s; }
    .button-gen.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 12px rgba(233, 30, 99, 0.3); }
    .generation-title { font-size: 1.1rem; color: var(--primary); margin: 30px 0 15px 0; font-weight: 900; text-transform: uppercase; letter-spacing: 1px; padding-left: 15px; border-left: 4px solid var(--primary); }
    .member-grid-layout { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    .member-card { background: white; border-radius: 14px; overflow: hidden; box-shadow: 0 3px 10px rgba(0, 0, 0, 0.04); }
    .member-photo-container img { width: 100%; aspect-ratio: 1/1; object-fit: cover; }
    .member-info-box { padding: 10px 5px; text-align: center; }
    .member-name-text { font-weight: 800; font-size: 0.8rem; color: var(--dark); margin-bottom: 2px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
    .member-team-text { font-size: 0.65rem; color: #aaa; font-weight: 700; text-transform: uppercase; }

    /* --- MODALS --- */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 2000; display: none; justify-content: center; align-items: flex-end; backdrop-filter: blur(5px); }
    .modal-overlay.active { display: flex; animation: fadeIn 0.3s forwards; }
    .modal-content { background: white; width: 100%; height: 90vh; border-radius: 25px 25px 0 0; overflow-y: auto; position: relative; display: flex; flex-direction: column; animation: slideUp 0.3s ease; box-shadow: 0 -5px 40px rgba(0, 0, 0, 0.2); }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .modal-close-btn { position: absolute; top: 20px; right: 20px; background: rgba(255, 255, 255, 0.8); color: #333; width: 35px; height: 35px; border-radius: 50%; border: none; font-size: 1.2rem; cursor: pointer; z-index: 20; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); display: flex; align-items: center; justify-content: center; }
    .modal-header-bg { height: 150px; background: linear-gradient(45deg, #ff80ab, #e91e63); width: 100%; flex-shrink: 0; }
    .modal-profile-img { width: 130px; height: 130px; border-radius: 50%; border: 5px solid white; object-fit: cover; margin-top: -65px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15); background: #fff; align-self: center; }
    .modal-body { padding: 10px 25px 100px 25px; text-align: center; }
    .modal-title { font-family: 'Montserrat'; font-weight: 900; font-size: 1.6rem; margin-top: 15px; margin-bottom: 5px; color: var(--dark); }
    .modal-sub { color: #888; font-size: 0.9rem; margin-bottom: 25px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
    
    .disco-header-info { padding: 30px 25px 10px 25px; text-align: center; }
    .disco-cover-large { width: 140px; height: 140px; border-radius: 12px; object-fit: cover; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15); margin-bottom: 15px; }
    .disco-title-large { font-family: 'Montserrat'; font-weight: 900; font-size: 1.4rem; color: var(--dark); margin-bottom: 5px; }
    .disco-sub-large { color: var(--primary); font-size: 0.85rem; font-weight: 700; text-transform: uppercase; }
    
    .tabs { display: flex; border-bottom: 1px solid #eee; margin-bottom: 25px; justify-content: center; gap: 15px; margin-top: 15px; }
    .tab-btn { background: none; border: none; font-weight: 700; font-size: 0.9rem; color: #ccc; padding: 10px 5px; border-bottom: 3px solid transparent; transition: 0.3s; cursor: pointer; }
    .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
    .tab-content { display: none; text-align: left; width: 100%; }
    .tab-content.active { display: block; animation: fadeIn 0.3s; }
    
    .modal-nav { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
    .modal-nav-btn { background: #f5f5f5; border: none; padding: 8px 20px; border-radius: 20px; font-weight: 700; color: #777; font-size: 0.85rem; transition: 0.2s; cursor: pointer; }
    .modal-nav-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(233, 30, 99, 0.3); }
    .modal-section { display: none; animation: fadeIn 0.3s; }
    .modal-section.active { display: block; }
    
    .tracklist { list-style: none; padding: 0; }
    .tracklist li { padding: 12px 0; border-bottom: 1px dashed #eee; font-size: 0.9rem; color: #555; display: flex; justify-content: space-between; align-items: center; }
    .tracklist li:last-child { border-bottom: none; }

    /* --- NOVOS ESTILOS: LABELS COM ÍCONES --- */
    .label { font-size: 0.6em; padding: 3px 8px; border-radius: 6px; color: white; margin-left: 5px; vertical-align: middle; text-transform: uppercase; font-weight: 800; letter-spacing: 0.5px; display: inline-flex; align-items: center; gap: 4px; }
    .label.a-side { background-color: #4a90e2; } 
    .label.b-side { background-color: #ff9800; } 
    .label.center { background-color: #f44336; } 
    .label.unit { background-color: #9c27b0; } 
    .label.senbatsu { background: linear-gradient(135deg, #FFD700, #FDB931); color: #444; text-shadow: none; } /* Dourado */
    .label.solo { background-color: #E91E63; } /* Rosa forte */
    .label.undergirls { background-color: #00BCD4; } /* Azul Ciano */

    /* --- NOVOS ESTILOS: ACORDEÃO DE FORMAÇÃO --- */
    .formation-group { background: #fff; border: 1px solid #eee; border-radius: 12px; margin-bottom: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
    .formation-header { padding: 15px; background: #fdfdfd; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s; }
    .formation-header:active { background: #f0f0f0; }
    .formation-title { margin: 0 !important; text-align: left !important; font-size: 0.85rem !important; color: var(--dark) !important; display: flex; align-items: center; gap: 10px; font-weight: 800 !important; text-transform: uppercase; letter-spacing: 1px; }
    .formation-arrow { color: #bbb; transition: transform 0.3s ease; }
    .formation-group.open .formation-arrow { transform: rotate(180deg); }
    .formation-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out, padding 0.3s ease; background: white; }
    .formation-group.open .formation-content { max-height: 2000px; padding: 15px; border-top: 1px solid #f5f5f5; }

    /* ÍCONE IDOL (Formação Header) */
    .formation-idol-icon {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #ff77b7, #e91e63);
      color: #fff;
      box-shadow: 0 6px 16px rgba(233, 30, 99, 0.22);
      border: 1px solid rgba(255,255,255,0.75);
      flex: 0 0 auto;
    }
    .formation-idol-icon i {
      font-size: 0.75rem;
      line-height: 1;
    }
    
    /* Grid Interno da Formação */
    .member-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; justify-content: center; margin-top: 0; }
    .member-card-static { background: #fff; border-radius: 12px; padding: 10px 5px; text-align: center; box-shadow: 0 3px 8px rgba(0, 0, 0, 0.04); border: 1px solid #f9f9f9; display: flex; flex-direction: column; align-items: center; text-decoration: none; color: inherit; }
    .member-photo { width: 60px; height: 60px; border-radius: 50%; overflow: hidden; margin-bottom: 8px; border: 3px solid #f0f0f0; }
    .member-photo img { width: 100%; height: 100%; object-fit: cover; }
    .member-card-static.is-center .member-photo { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(233, 30, 99, 0.2); }
    .member-info h3 { font-size: 0.7rem; font-weight: 800; color: var(--dark); margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
    .member-info p { font-size: 0.6rem; color: #999; margin-top: 2px; font-weight: 500; }

    /* Participações (Part Card) */
    #m-part { display: flex; flex-direction: column; gap: 15px; }
    .part-card { background: #fff; border-radius: 16px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.04); border: 1px solid #fafafa; overflow: hidden; }
    .part-header { background: var(--primary-soft); padding: 12px 15px; color: var(--primary); font-weight: 800; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; }
    .part-list { list-style: none; padding: 0; margin: 0; }
    .part-list li { padding: 12px 15px; border-bottom: 1px solid #f5f5f5; display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; color: var(--dark); }
    .part-list li:last-child { border-bottom: none; }
    .song-name { font-weight: 600; font-size: 0.85rem; }
    .song-badges { display: flex; gap: 4px; flex-wrap: wrap; justify-content: flex-end; }
    
    .gallery-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; }
    .gallery-grid img { width: 100%; aspect-ratio: 1/1; object-fit: cover; border-radius: 8px; }
    
    /* Bottom Nav */
    .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 75px; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(15px); display: flex; border-top: 1px solid rgba(0, 0, 0, 0.05); z-index: 1000; padding-bottom: env(safe-area-inset-bottom); box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.03); }
    .nav-item { flex: 1; border: none; background: none; color: #ccc; font-size: 0.65rem; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: 600; cursor: pointer; transition: 0.2s; }
    .nav-item.active { color: var(--primary); }
    .nav-item i { font-size: 1.5rem; margin-bottom: 4px; transition: 0.2s; }
    .nav-item.active i { transform: translateY(-3px); }
    .btn-main { width: 100%; padding: 14px; border: none; border-radius: 999px; background: var(--primary); color: #fff; font-weight: 900; cursor: pointer; }

    /* --- SEN PICK: itens já escolhidos --- */
    .select-item.is-picked {
      background: #fff0f5;
      border: 2px solid rgba(233,30,99,.35);
      position: relative;
    }
    .select-item.is-picked::after{
      content: "✓";
      position: absolute;
      top: 8px;
      right: 10px;
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background: var(--primary);
      color: #fff;
      font-weight: 900;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow: 0 6px 16px rgba(233,30,99,.25);
    }

    /* SENBATSU MAKER STYLES */
    .selection-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,.8); z-index: 3000; display: none; justify-content: center; align-items: center; padding: 16px; }
    .selection-box { background: #fff; width: 92%; max-width: 900px; max-height: 85vh; border-radius: 18px; padding: 16px; display: flex; flex-direction: column; overflow: hidden; }
    .selection-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(88px, 1fr)); gap: 10px; overflow-y: auto; padding: 10px; border-radius: 14px; background: #fafafa; border: 1px solid #eee; }
    .select-item { text-align: center; cursor: pointer; padding: 8px 6px; border-radius: 12px; transition: .15s; user-select: none; }
    .select-item:hover { background: #fff0f5; }
    .select-item img { width: 66px; height: 66px; border-radius: 50%; object-fit: cover; border: 2px solid #eee; background: #fff; }
    .select-item div { font-size: .72rem; font-weight: 900; margin-top: 6px; line-height: 1.15; color: #333; }
    #sen-modal.modal-overlay { align-items: flex-end; }
    #sen-modal .modal-content { height: 92vh; }
    .sen-stage { padding: 18px 18px 110px 18px; }
    .sen-print-area { background: #fff; border-radius: 18px; padding: 14px; box-shadow: 0 8px 20px rgba(0,0,0,.06); border: 1px solid #f3f3f3; }
    .sen-title { text-align: center; font-family: 'Montserrat', sans-serif; font-weight: 900; color: var(--primary); letter-spacing: 1px; text-transform: uppercase; font-size: .95rem; margin-bottom: 4px; }
    .sen-subtitle { text-align: center; font-weight: 800; color: #444; font-size: .9rem; margin-bottom: 12px; }
    .sen-rows-wrap { display:flex; flex-direction: column-reverse; gap:14px; }
    .sen-row { display:flex; justify-content:center; gap:10px; flex-wrap:wrap; }
    .sen-slot { width: 76px; text-align: center; cursor: pointer; position: relative; }
    .sen-circle { width: 66px; height: 66px; border-radius: 50%; background: #fff; border: 2px solid #eaeaea; display:flex; align-items:center; justify-content:center; overflow:hidden; margin: 0 auto; }
    .sen-slot.is-center .sen-circle{ border-color: var(--primary); box-shadow: 0 0 0 4px rgba(233,30,99,.18); transform: scale(1.04); }
    .sen-badge{ position:absolute; bottom: 20px; right: 5px; width: 20px; height: 20px; border-radius: 50%; background: #333; color:#fff; font-size:.65rem; font-weight:900; display:flex; align-items:center; justify-content:center; border:2px solid #fff; }
    .sen-slot.is-center .sen-badge{ background: var(--primary); }
    .sen-name{ font-size: .68rem; font-weight: 900; margin-top: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color:#333; }

    /* --- CHART CARD STYLES --- */
    .chart-card{
      background:#fff;
      border-radius:16px;
      border:1px solid #fafafa;
      box-shadow:0 4px 15px rgba(0,0,0,.04);
      padding:14px;
      display:flex;
      gap:12px;
      align-items:center;
      margin-bottom:12px;
    }
    .chart-photo{
      width:54px;height:54px;border-radius:50%;
      object-fit:cover;border:2px solid #eee;background:#fff;
    }
    .chart-meta{ flex:1; }
    .chart-name{ font-weight:900; }
    .chart-sub{ color:#999; font-weight:800; font-size:.75rem; text-transform:uppercase; margin-top:2px; }
    .chart-badges{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    .chart-pill{
      background:#f5f5f5;
      border-radius:999px;
      padding:8px 10px;
      font-weight:900;
      font-size:.75rem;
      color:#555;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .chart-pill i{ color: var(--primary); }

    @media (max-width: 600px) {
        .sen-slot { width: 52px; }
        .sen-circle { width: 44px; height: 44px; border-width: 1px; }
        .sen-badge { width: 16px; height: 16px; font-size: 0.55rem; bottom: 16px; right: 0; border-width: 1px; }
        .sen-name { font-size: 0.55rem; margin-top: 3px; }
        .sen-row { gap: 4px; }
        .sen-rows-wrap { gap: 10px; }
        .sen-stage { padding: 10px 5px 100px 5px; }
        .sen-print-area { padding: 10px 6px; }
    }
  </style>
</head>

<body>

  <div class="header"><div class="logo">CTL48</div></div>

  <div id="view-home" class="view-section active">
    <div class="hero">
      <img id="hero-bg" class="hero-bg" src="">
      <div style="position:relative; z-index:2;">
        <div class="hero-tag">ÚLTIMO LANÇAMENTO</div>
        <h1 id="hero-title" class="hero-title">Carregando...</h1>
        <p id="hero-sub" class="hero-sub"></p>
      </div>
    </div>
    <div class="container">
      <h2 class="section-title">Notícias</h2>
      <div id="news-list"><div style="text-align:center; padding:20px; color:#aaa;">Carregando...</div></div>
    </div>
  </div>

  <div id="view-disco" class="view-section">
    <div class="discography-container">
      <h2 class="section-title">Discografia</h2>
      <div id="disco-grid" class="single-grid"><div style="text-align:center; grid-column:1/-1; color:#aaa;">Carregando...</div></div>
    </div>
  </div>

  <div id="view-members" class="view-section">
    <div class="container">
      <h2 class="section-title">Membros</h2>
      <div class="filter-bar">
        <button class="filter-btn active" onclick="setMemberFilter('gen', this)">Por Geração</button>
        <button class="filter-btn" onclick="setMemberFilter('team', this)">Por Team</button>
      </div>
      <div id="scroll-buttons"></div>
      <div id="members-container"><div style="text-align:center; padding:20px; color:#aaa;">Carregando...</div></div>
    </div>
  </div>

  <div id="view-charts" class="view-section">
    <div class="container">
      <h2 class="section-title">Charts dos Membros</h2>
   
      <div style="display:flex; gap:10px; margin-bottom:12px;">
        <input id="ch-q" placeholder="Buscar membro..." oninput="renderCharts()" style="flex:1;padding:12px;border:1px solid #eee;border-radius:12px;">
        <select id="ch-sort" onchange="renderCharts()" style="padding:12px;border:1px solid #eee;border-radius:12px;">
          <option value="songs">Mais músicas</option>
          <option value="centers">Mais centers</option>
          <option value="aside_centers">Mais A-side</option>
          <option value="name">Nome</option>
        </select>
      </div>

      <label style="display:flex;gap:10px;align-items:center;font-weight:900;color:#555;margin-bottom:12px;">
        <input id="ch-only-aside-center" type="checkbox" onchange="renderCharts()">
        Mostrar apenas quem tem Senbatsu 
      </label>
   
      <div id="charts-list">
        <div style="text-align:center; padding:20px; color:#aaa;">Carregando...</div>
      </div>
    </div>
  </div>

  <div id="view-senbatsu" class="view-section">
    <div class="container">
      <h2 class="section-title">Senbatsu Maker</h2>
      <div style="background:#fff;border-radius:16px;padding:15px;box-shadow:0 4px 15px rgba(0,0,0,.03);">
        <label style="font-weight:900;font-size:.75rem;color:#555;text-transform:uppercase;">Nome do Single</label>
        <input id="s-single" placeholder="Ex: 10th Single" style="width:100%;padding:12px;border:1px solid #eee;border-radius:12px;margin:8px 0 12px 0;">
        <label style="font-weight:900;font-size:.75rem;color:#555;text-transform:uppercase;">Nome da Música</label>
        <input id="s-song" placeholder="Ex: A-side Title" style="width:100%;padding:12px;border:1px solid #eee;border-radius:12px;margin:8px 0 12px 0;">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
          <div>
            <label style="font-weight:900;font-size:.75rem;color:#555;text-transform:uppercase;">Fileiras</label>
            <select id="s-rowcount" onchange="senRenderRowInputs()" style="width:100%;padding:12px;border:1px solid #eee;border-radius:12px;margin-top:8px;">
              <option value="1">1</option><option value="2">2</option><option value="3" selected>3</option><option value="4">4</option>
            </select>
          </div>
          <div>
            <label style="font-weight:900;font-size:.75rem;color:#555;text-transform:uppercase;">Centers</label>
            <input id="s-centers" type="number" value="1" min="0" style="width:100%;padding:12px;border:1px solid #eee;border-radius:12px;margin-top:8px;">
          </div>
        </div>
        <div id="s-row-inputs" style="margin-top:12px;"></div>
        <button onclick="senStart()" style="margin-top:14px;width:100%;padding:14px;border:none;border-radius:999px;background:var(--primary);color:#fff;font-weight:900;">Montar Formação</button>
      </div>
    </div>
  </div>

  <div id="member-modal" class="modal-overlay">
    <div class="modal-content">
      <button class="modal-close-btn" onclick="closeModal('member-modal')"><i class="fas fa-times"></i></button>
      <div class="modal-header-bg"></div>
      <div style="display:flex; justify-content:center;"><img id="m-cover" class="modal-profile-img" src=""></div>
      <div class="modal-body">
        <div class="modal-title" id="m-name">Nome</div>
        <div class="modal-sub" id="m-team">Team</div>
        <div class="tabs">
          <button class="tab-btn active" onclick="tab('perfil', this)">Perfil</button>
          <button class="tab-btn" onclick="tab('galeria', this)">Galeria</button>
          <button class="tab-btn" onclick="tab('part', this)">Músicas</button>
        </div>
        <div id="tab-perfil" class="tab-content active"><p id="m-bio" style="line-height:1.7; color:#555; font-size:0.9rem; padding:0 10px;">...</p></div>
        <div id="tab-galeria" class="tab-content"><div id="m-gallery" class="gallery-grid"></div></div>
        <div id="tab-part" class="tab-content"><div id="m-part"></div></div>
      </div>
    </div>
  </div>

  <div id="disco-modal" class="modal-overlay">
    <div class="modal-content">
      <button class="modal-close-btn" onclick="closeModal('disco-modal')"><i class="fas fa-times"></i></button>
      <div class="disco-header-info">
        <img id="dm-cover" class="disco-cover-large" src="">
        <div id="dm-title" class="disco-title-large">Título</div>
        <div id="dm-sub" class="disco-sub-large">Tipo</div>
      </div>
      <div id="dm-content" style="padding: 0 20px 40px 20px;"></div>
    </div>
  </div>

  <div id="sen-modal" class="modal-overlay">
    <div class="modal-content">
      <button class="modal-close-btn" onclick="senClose()"><i class="fas fa-times"></i></button>
      <div class="modal-header-bg"></div>
      <div class="sen-stage">
        <div class="sen-print-area" id="sen-print">
          <div class="sen-title" id="sen-print-single">(SINGLE)</div>
          <div class="sen-subtitle" id="sen-print-song">(MÚSICA)</div>
          <div class="sen-rows-wrap" id="sen-rows"></div>
        </div>
        <div style="display:flex; gap:10px; margin-top:14px;">
          <button class="modal-nav-btn" style="flex:1" onclick="senClear()">Limpar</button>
          <button class="modal-nav-btn" style="flex:1" onclick="senPrint()">Print</button>
        </div>
        <p style="text-align:center;color:#999;font-weight:700;margin-top:10px;font-size:.85rem;">Toque numa bolinha para escolher um membro.</p>
      </div>
    </div>
  </div>

  <div id="sen-pick" class="selection-modal">
    <div class="selection-box">
      <div style="display:flex; justify-content:space-between; margin-bottom:12px; align-items:center;">
        <h3 style="margin:0;">Escolha</h3><button onclick="senClosePicker()" style="border:none;background:none;font-size:1.5rem;">✕</button>
      </div>
      <div style="display:flex; gap:10px; margin-bottom:10px;">
        <select id="sen-filter-team" onchange="senRenderPicker()" style="flex:1;"><option value="">Times</option><option>Team C</option><option>Team T</option><option>Team L</option><option>Team Kenkyuusei</option></select>
        <select id="sen-filter-gen" onchange="senRenderPicker()" style="flex:1;"><option value="">Gens</option><option value="1">1ª</option><option value="2">2ª</option><option value="3">3ª</option><option value="4">4ª</option><option value="5">5ª</option></select>
      </div>
      <input id="sen-filter-q" placeholder="Buscar..." oninput="senRenderPicker()" style="width:100%; padding:12px; border:1px solid #eee; border-radius:12px; margin-bottom:12px;">
      <div class="selection-grid" id="sen-pick-grid"></div>
      <button class="btn-main" style="background:#f44336; margin-top:12px;" onclick="senPickEmpty()">Remover (Vazio)</button>
    </div>
  </div>

  <div class="bottom-nav">
    <button class="nav-item active" onclick="switchTab('view-home', this)"><i class="fas fa-home"></i> Home</button>
    <button class="nav-item" onclick="switchTab('view-disco', this)"><i class="fas fa-compact-disc"></i> Disco</button>
    <button class="nav-item" onclick="switchTab('view-members', this)"><i class="fas fa-users"></i> Membros</button>
    <button class="nav-item" onclick="switchTab('view-charts', this)"><i class="fas fa-chart-column"></i> Charts</button>
    <button class="nav-item" onclick="switchTab('view-senbatsu', this)"><i class="fas fa-star"></i> Senbatsu</button>
  </div>

  <script>
    const SUPABASE_URL = "https://iooyygtaosshxygnhlco.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlvb3l5Z3Rhb3NzaHh5Z25obGNvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwMDEyNTUsImV4cCI6MjA4NDU3NzI1NX0.gfcVtNgn3g1gnFVrtaIqzkWxajYiV_KbtycYsE9OZ0Y";

    if (!window.supabase) { alert("Supabase não carregou."); throw new Error("Supabase CDN failed."); }
    const _supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const T_NEWS = "Noticias";
    const T_DISCO = "Discografia";
    const T_MEMBERS = "Membros";

    let loadedMembers = [];
    let currentFilter = "gen";

    // --- VARIÁVEIS E FUNÇÕES PARA ORDENAÇÃO POR ID ---
    let discographyRows = [];
    let discographyOrderMap = new Map(); // titulo(normalizado) -> Id

    function normKey(s){
      return String(s || "")
        .toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .replace(/[^a-z0-9]+/g, " ")
        .trim();
    }

    // Função auxiliar para normalizar texto (tira acentos, hifen, espacos extras)
    function normTxt(s){
      return String(s || "")
        .toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .replace(/[^a-z0-9]+/g, " ")
        .replace(/\s+/g, " ")
        .trim();
    }

    // Função inteligente para escolher ícone baseado no título
    function pickFormationIcon(titleText){
      const t = normTxt(titleText);
      let icon = "fa-music"; // default
      if (t.includes("a side") || t.includes("aside")) icon = "fa-star";
      else if (t.includes("b side") || t.includes("bside")) icon = "fa-compact-disc";
      else if (t.includes("undergirls") || t.includes("under girls")) icon = "fa-gem";
      else if (t.includes("unit")) icon = "fa-users";
      else if (t.includes("solo")) icon = "fa-microphone";
      else if (t.includes("senbatsu")) icon = "fa-crown";
      return icon;
    }

    // Função auxiliar para pegar o ID independente de como está escrito (id, Id, ID)
    function getIdSafe(r) {
      return Number(r.id ?? r.Id ?? r.ID ?? 0);
    }

    function rebuildDiscographyOrderMap(list){
      discographyRows = Array.isArray(list) ? list : [];
      discographyOrderMap = new Map();

      discographyRows.forEach((r) => {
        const id = getIdSafe(r);
        const key = normKey(r.Titulo || "");
        // Só adiciona ao mapa se tiver um ID válido
        if (key && id > 0) discographyOrderMap.set(key, id);
      });
    }

    function getDiscographyIdForParticipation(p){
      const key = normKey(p?.single || "");
      // Se achou no mapa, retorna o ID. Se não, retorna 999999 para ir pro final.
      return discographyOrderMap.has(key) ? discographyOrderMap.get(key) : 999999;
    }
    // ---------------------------------------------------

    function switchTab(id, el) {
      document.querySelectorAll(".view-section").forEach((s) => s.classList.remove("active"));
      document.querySelectorAll(".nav-item").forEach((n) => n.classList.remove("active"));
      document.getElementById(id).classList.add("active");
      if (el) el.classList.add("active");
      window.scrollTo(0, 0);
    }

    function resolveImage(field) {
      if (!field) return "";
      if (Array.isArray(field) && field.length > 0) field = field[0];
      if (typeof field === "object") {
        if (field.url) return String(field.url).trim();
        if (field.publicUrl) return String(field.publicUrl).trim();
        field = field.path || "";
      }
      let s = String(field).trim();
      if (!s) return "";
      if (s.includes("(") && s.includes(")") && s.includes("http")) {
        const lastOpen = s.lastIndexOf("(");
        const lastClose = s.lastIndexOf(")");
        if (lastOpen !== -1 && lastClose !== -1 && lastClose > lastOpen) {
          const inside = s.slice(lastOpen + 1, lastClose).trim();
          if (inside.startsWith("http://") || inside.startsWith("https://")) s = inside;
        }
      }
      s = s.replace(/^"+|"+$/g, "").trim();
      s = s.replace(/%20+$/g, "").trim();
      const firstHttp = s.indexOf("http");
      if (firstHttp > 0) s = s.slice(firstHttp).trim();
      if (s.startsWith("http://") || s.startsWith("https://")) return s;
      return "";
    }

    function getImgUrl(field) { return resolveImage(field); }
    function getGalleryUrls(field) {
      if (!field) return [];
      if (Array.isArray(field)) return field.map(resolveImage).filter(Boolean);
      if (typeof field === "string" && field.trim().startsWith("[")) {
        try {
          const arr = JSON.parse(field);
          if (Array.isArray(arr)) return arr.map(resolveImage).filter(Boolean);
        } catch (e) {}
      }
      const one = resolveImage(field);
      return one ? [one] : [];
    }

    // --- CHARTS LOGIC ---
    function safeJson(v){
      if(!v) return null;
      if(typeof v === "object") return v;
      if(typeof v === "string"){
        const s = v.trim();
        if(!s) return null;
        try { return JSON.parse(s); } catch(e){ return null; }
      }
      return null;
    }

    function flattenTracks(participations){
      // retorna array de tracks (cada track = {title, labels, ...})
      const tracks = [];
      (participations || []).forEach(p => {
        const arr = Array.isArray(p.tracks) ? p.tracks : (p.tracks ? [p.tracks] : []);
        arr.forEach(t => { if(t) tracks.push(t); });
      });
      return tracks;
    }

    // --- NOVA FUNÇÃO (Center só A-side) ---
    function countAsideCentersFromTracks(tracks){
      let c = 0;
      (tracks || []).forEach(t => {
        const labels = Array.isArray(t.labels) ? t.labels : [];
        const norm = labels.map(l =>
          String(l||"").toLowerCase().trim().replace(/\s+/g,"-")
        );

        const hasCenter = norm.includes("center");
        const hasAside =
          norm.includes("a-side") ||
          norm.includes("aside") ||
          norm.includes("a-side");

        if (hasCenter && hasAside) c++;
      });
      return c;
    }

    // Mantida para compatibilidade, se necessário
    function countCentersFromTracks(tracks){
      let c = 0;
      (tracks||[]).forEach(t => {
        const labels = Array.isArray(t.labels) ? t.labels : [];
        const hasCenter = labels.some(l => String(l||"").toLowerCase().trim().replace(/\s+/g,"-") === "center");
        if(hasCenter) c++;
      });
      return c;
    }

    function countAsideFromTracks(tracks){
      let c = 0;
      (tracks||[]).forEach(t => {
        const labels = Array.isArray(t.labels) ? t.labels : [];
        const norm = labels.map(l => String(l||"").toLowerCase().trim().replace(/\s+/g,"-"));
        
        const hasAside = norm.includes("a-side") || norm.includes("aside") || norm.includes("a-side");
        if(hasAside) c++;
      });
      return c;
    }

    function buildMemberStats(){
      const EX = new Set(["graduada","demitida","expulsa"]);
      const list = (loadedMembers || []).filter(m => !EX.has((m.Status||"").trim().toLowerCase()));

      return list.map(m => {
        const part = safeJson(m.Participacoes);
        const participations = Array.isArray(part) ? part : [];
        const tracks = flattenTracks(participations);

        return {
          name: m.Nome || "",
          team: m.Time || "",
          gen: m.Geracao || "",
          photo: getImgUrl(m.Foto) || "https://placehold.co/120x120?text=?",
          songs: tracks.length,                // total de músicas listadas
          centers: countAsideCentersFromTracks(tracks), // ⭐ center só em A-side
          asideSongs: countAsideFromTracks(tracks) // quantos A-side
        };
      });
    }

    function renderCharts(){
      const box = document.getElementById("charts-list");
      if(!box) return;

      const q = (document.getElementById("ch-q")?.value || "").toLowerCase().trim();
      const sort = (document.getElementById("ch-sort")?.value || "songs").trim();
      const onlyAside = !!document.getElementById("ch-only-aside-center")?.checked;

      let stats = buildMemberStats();
      if(q) stats = stats.filter(x => x.name.toLowerCase().includes(q));
      if(onlyAside) stats = stats.filter(x => x.asideSongs > 0);

      if(sort === "centers") stats.sort((a,b) => (b.centers - a.centers) || (b.songs - a.songs) || a.name.localeCompare(b.name,"pt-BR"));
      else if(sort === "aside_centers") stats.sort((a,b) => (b.asideSongs - a.asideSongs) || (b.songs - a.songs) || a.name.localeCompare(b.name,"pt-BR"));
      else if(sort === "name") stats.sort((a,b) => a.name.localeCompare(b.name,"pt-BR"));
      else stats.sort((a,b) => (b.songs - a.songs) || (b.centers - a.centers) || a.name.localeCompare(b.name,"pt-BR"));

      if(!stats.length){
        box.innerHTML = `<p style="text-align:center;color:#999;font-weight:800;margin-top:18px;">Nenhum membro.</p>`;
        return;
      }

      // ATUALIZADO: Label "Centers"
      box.innerHTML = stats.map(s => `
        <div class="chart-card">
          <img class="chart-photo" src="${s.photo}" onerror="this.src='https://placehold.co/120x120?text=?'">
          <div class="chart-meta">
            <div class="chart-name">${s.name}</div>
            <div class="chart-sub">${s.team} • ${s.gen}</div>
          </div>
          <div class="chart-badges">
            <span class="chart-pill"><i class="fas fa-microphone"></i> ${s.songs} músicas</span>
            <span class="chart-pill"><i class="fas fa-star"></i> ${s.centers} Centers</span>
            <span class="chart-pill" style="background:#fff0f5;color:#e91e63"><i class="fas fa-star"></i> ${s.asideSongs} Senbatsu</span>
          </div>
        </div>
      `).join("");
    }

    // --- SENBATSU UTILS ---
    let senConfig = { rowcount: 3, rows: [6,5,5], centers: 1, single: "", song: "" };
    let senSlots = [];
    let senPickingIndex = -1;

    function senPickedKey(m){
        // tenta usar um ID se existir; senão usa Nome+Time+Geracao
        return String(m?.id ?? m?.Id ?? m?.ID ?? `${m?.Nome||""}|${m?.Time||""}|${m?.Geracao||""}`).trim();
    }

    function senGetPickedSet(){
        const set = new Set();
        (senSlots || []).forEach(m => { if(m) set.add(senPickedKey(m)); });
        return set;
    }

    function senRenderRowInputs() {
      const rc = parseInt(document.getElementById("s-rowcount").value, 10);
      const wrap = document.getElementById("s-row-inputs");
      wrap.innerHTML = "";
      const defaults = { 1:[16], 2:[8,8], 3:[6,5,5], 4:[4,4,4,4] };
      const arr = defaults[rc] ? [...defaults[rc]] : Array.from({length:rc}, ()=>4);
      wrap.innerHTML += `<div style="margin-bottom:8px;color:#777;font-weight:800;font-size:.8rem;">Tamanho de cada fileira</div>`;
      const labels = ["Frente (Front)", "Meio", "Fundo", "Fundo 2"];
      arr.forEach((v, i) => {
        const lbl = labels[i] || `Fila ${i+1}`;
        wrap.innerHTML += `<div style="display:flex; gap:10px; align-items:center; margin-bottom:8px;"><div style="min-width:90px;font-weight:900;color:#444;">${lbl}</div><input type="number" min="1" value="${v}" id="s-row-${i}" style="flex:1;padding:12px;border:1px solid #eee;border-radius:12px;"></div>`;
      });
    }
    senRenderRowInputs();

    function senStart() {
      if(!loadedMembers || loadedMembers.length === 0){ alert("Membros ainda carregando..."); return; }
      const rc = parseInt(document.getElementById("s-rowcount").value, 10);
      const centers = Math.max(0, parseInt(document.getElementById("s-centers").value || "0", 10));
      const single = (document.getElementById("s-single").value || "").trim();
      const song = (document.getElementById("s-song").value || "").trim();
      const rows = [];
      let total = 0;
      for(let i=0;i<rc;i++){
        const v = Math.max(1, parseInt(document.getElementById(`s-row-${i}`).value || "1", 10));
        rows.push(v); total += v;
      }
      if(centers > total){ alert("Muitos centers."); return; }
      senConfig = { rowcount: rc, rows, centers, single, song };
      senSlots = Array.from({length: total}, ()=>null);
      document.getElementById("sen-modal").classList.add("active");
      document.getElementById("sen-print-single").innerText = single ? single : "(NOME DO SINGLE)";
      document.getElementById("sen-print-song").innerText = song ? song : "(FORMAÇÃO ESCOLHIDA)";
      senRenderStage();
    }

    function senClose() { document.getElementById("sen-modal").classList.remove("active"); senClosePicker(); }
    function senClear() { senSlots = senSlots.map(()=>null); senRenderStage(); }

    function senRenderStage() {
      const rowsWrap = document.getElementById("sen-rows");
      rowsWrap.innerHTML = "";
      let badgeCounter = 1;
      let globalIdx = 0;
      for(let r=0; r<senConfig.rowcount; r++){
        const rowDiv = document.createElement("div");
        rowDiv.className = "sen-row";
        const rowLen = senConfig.rows[r];
        let indices = [];
        for(let k=0; k<rowLen; k++) indices.push(globalIdx + k);
        let leftSide = [];
        let rightSide = [];
        for(let k=0; k<rowLen; k++){
            if(k === 0) { } else if (k % 2 !== 0) { leftSide.push(indices[k]); } else { rightSide.push(indices[k]); }
        }
        let visualIndices = [...leftSide.reverse(), indices[0], ...rightSide];
        visualIndices.forEach((dataIndex) => {
            const badgeNum = dataIndex + 1;
            const member = senSlots[dataIndex];
            const isCenter = badgeNum <= senConfig.centers;
            const photo = member ? (getImgUrl(member.Foto) || "") : "";
            const name = member ? (member.Nome || "Membro") : "Vazio";
            const slot = document.createElement("div");
            slot.className = "sen-slot" + (isCenter ? " is-center" : "");
            (function(capturedIdx){ slot.onclick = () => senOpenPicker(capturedIdx); })(dataIndex);
            slot.innerHTML = `<div class="sen-badge">${badgeNum}</div><div class="sen-circle">${photo ? `<img src="${photo}" style="width:100%;height:100%;object-fit:cover;" onerror="this.style.display='none'">` : `<i class="fas fa-user" style="color:#bbb;"></i>`}</div><div class="sen-name">${name}</div>`;
            rowDiv.appendChild(slot);
        });
        rowsWrap.appendChild(rowDiv);
        globalIdx += rowLen;
      }
    }

    function senOpenPicker(index) {
      senPickingIndex = index;
      document.getElementById("sen-pick").style.display = "flex";
      senRenderPicker();
    }
    function senClosePicker() { document.getElementById("sen-pick").style.display = "none"; senPickingIndex = -1; }
    function senPickEmpty() { if(senPickingIndex < 0) return; senSlots[senPickingIndex] = null; senClosePicker(); senRenderStage(); }

    function senRenderPicker() {
      const grid = document.getElementById("sen-pick-grid");
      grid.innerHTML = "";

      const t = document.getElementById("sen-filter-team").value.trim();
      const g = document.getElementById("sen-filter-gen").value.trim();
      const q = (document.getElementById("sen-filter-q").value || "").toLowerCase().trim();

      const EX = new Set(["graduada","demitida","expulsa"]);
      let list = (loadedMembers || []).filter(m => !EX.has((m.Status||"").trim().toLowerCase()));
      if(t) list = list.filter(m => (m.Time||"") === t);
      if(g) list = list.filter(m => String(m.Geracao||"").includes(g));
      if(q) list = list.filter(m => String(m.Nome||"").toLowerCase().includes(q));

      const picked = senGetPickedSet();

      list.forEach(m => {
        const url = getImgUrl(m.Foto) || "https://placehold.co/120x120?text=?";
        const key = senPickedKey(m);
        const isPicked = picked.has(key);

        const item = document.createElement("div");
        item.className = "select-item" + (isPicked ? " is-picked" : "");
        item.innerHTML = `
          <img src="${url}" onerror="this.src='https://placehold.co/120x120?text=?'">
          <div>${m.Nome || ""}</div>
        `;

        item.onclick = () => {
          if(senPickingIndex < 0) return;

          // se já foi escolhido em outro slot: move (tira do slot anterior)
          if (isPicked) {
            const oldIdx = (senSlots || []).findIndex(x => x && senPickedKey(x) === key);
            if (oldIdx >= 0) senSlots[oldIdx] = null;
          }

          senSlots[senPickingIndex] = m;
          senClosePicker();
          senRenderStage();
        };

        grid.appendChild(item);
      });

      if(list.length === 0) {
        grid.innerHTML = `<p style="grid-column:1/-1;text-align:center;color:#999;font-weight:800;">Nenhum membro encontrado.</p>`;
      }
    }

    async function senPrint() {
      const node = document.getElementById("sen-print");
      if(typeof html2canvas === 'undefined') return alert("Erro: Biblioteca html2canvas não carregada.");
      try {
        const canvas = await html2canvas(node, { backgroundColor: null, scale: 2, useCORS: true });
        const url = canvas.toDataURL("image/png");
        const w = window.open("");
        w.document.write(`<h2 style="text-align:center;font-family:sans-serif;">Seu Senbatsu</h2><img src="${url}" style="width:100%;max-width:900px;height:auto;display:block;margin:0 auto;border:1px solid #ccc;">`);
      } catch(e) { console.error(e); alert("Falha ao gerar print (Tente usar screenshots do celular)."); }
    }

    // --- INIT & CORE ---
    async function init() {
      console.log("Iniciando...");
      try {
        // 1. Carrega Notícias
        const { data: news } = await _supabase.from(T_NEWS).select("*").order("Data", { ascending: false }).limit(5);
        renderNews(news || []);
        
        // 2. Carrega Discografia (sem order no Supabase para evitar erro de coluna)
        const { data: discos, error } = await _supabase.from(T_DISCO).select("*");
        
        if (error) {
            console.error("Erro Disco:", error);
            document.getElementById("disco-grid").innerHTML = '<p style="text-align:center;width:100%;">Erro ao carregar discografia.</p>';
        } else {
            const listaDiscos = discos || [];

            // Monta o mapa para usar na ordenação das músicas dos membros
            rebuildDiscographyOrderMap(listaDiscos);
            
            // Ordena a lista de discos para exibir na aba (Decrescente: Maior ID primeiro)
            listaDiscos.sort((a, b) => getIdSafe(b) - getIdSafe(a));
            
            renderDisco(listaDiscos);
        }

        // 3. Carrega Membros
        const { data: members } = await _supabase.from(T_MEMBERS).select("*").order("Geracao", { ascending: true }).order("Nome", { ascending: true });
        loadedMembers = members || [];
        renderMembers();
        
        // 4. Renderiza Charts iniciais
        renderCharts();
        
      } catch (e) { 
          console.error("ERRO GERAL:", e); 
          alert("Erro ao conectar no banco de dados. Verifique o console."); 
      }
    }

    function renderNews(list) {
      const c = document.getElementById("news-list"); c.innerHTML = "";
      if (!list.length) { c.innerHTML = '<p style="text-align:center;color:#999">Sem notícias.</p>'; return; }
      list.forEach((r) => {
        const d = r.Data ? String(r.Data).split("-") : ["", "", ""];
        c.innerHTML += `<div class="news-item"><div class="news-date"><span>${d[2] || ""}</span>${d[1] || ""}</div><div class="news-content"><span class="news-tag">${r.Categoria || "News"}</span><h4>${r.Titulo || ""}</h4><div class="news-text">${r.Texto || ""}</div></div></div>`;
      });
    }

    function renderDisco(list) {
      const c = document.getElementById("disco-grid"); c.innerHTML = "";
      if (list.length > 0) {
        // Como a lista já vem decrescente (5, 4, 3...), o index [0] é o mais novo
        const l = list[0]; 
        document.getElementById("hero-title").innerText = l.Titulo || "—";
        document.getElementById("hero-sub").innerText = `${l.Tipo || ""}${l.Center ? ` • Center: ${l.Center}` : ""}`;
        document.getElementById("hero-bg").src = getImgUrl(l.Capa) || "";
      } else { c.innerHTML = '<p style="grid-column:1/-1;text-align:center;color:#999">Sem lançamentos.</p>'; return; }
      
      list.forEach((r) => {
        const safeData = encodeURIComponent(JSON.stringify({ title: r.Titulo, type: r.Tipo, cover: getImgUrl(r.Capa), content: r.Tracklist })).replace(/'/g, "%27");
        c.innerHTML += `<div class="single-card" onclick="openDiscoModal('${safeData}')"><div class="single-cover"><img src="${getImgUrl(r.Capa)}" loading="lazy" onerror="this.src='https://placehold.co/600x600?text=?'"></div><div class="single-info"><div class="single-title-text">${r.Titulo || ""}</div><div class="single-type-text">${r.Tipo || ""}</div></div></div>`;
      });
    }

    function openDiscoModal(json) {
        const data = JSON.parse(decodeURIComponent(json));
        document.getElementById("dm-title").innerText = data.title || "";
        document.getElementById("dm-sub").innerText = data.type || "";
        document.getElementById("dm-cover").src = data.cover || "";
        const contentBox = document.getElementById("dm-content");
        
        let htmlContent = data.content;
        if(typeof htmlContent === "object") htmlContent = JSON.stringify(htmlContent);
        contentBox.innerHTML = htmlContent || '<p style="text-align:center;color:#999; margin-top:20px;">Sem detalhes.</p>';
        
        const hasTabs = contentBox.querySelector(".modal-nav");
        const tracklistEl = contentBox.querySelector(".tracklist");
        
        if (!hasTabs && tracklistEl) {
            const tracklistHTML = tracklistEl.outerHTML;
            tracklistEl.remove();
            const formationHTML = contentBox.innerHTML; 
            contentBox.innerHTML = `
                <div class="modal-nav">
                    <button class="modal-nav-btn active" data-section="tracklist">Tracklist</button>
                    <button class="modal-nav-btn" data-section="formacao">Formação</button>
                </div>
                <div class="modal-section active" data-section="tracklist">${tracklistHTML}</div>
                <div class="modal-section" data-section="formacao" id="formation-tab-content">${formationHTML}</div>
            `;
        }

        // --- ACORDEÃO LOGIC (AUTOMÁTICO) ---
        const formationContext = document.getElementById("formation-tab-content") || contentBox;
        const groups = formationContext.querySelectorAll(".formation-group");

        groups.forEach(group => {
            const titleEl = group.querySelector(".formation-title");
            const gridEl = group.querySelector(".member-grid");
            if (titleEl && gridEl) {
                const headerDiv = document.createElement("div");
                headerDiv.className = "formation-header";

                const titleClone = titleEl.cloneNode(true);
                // USANDO A NOVA LÓGICA DE ICONES (NORMALIZADA)
                const rawText = (titleClone.innerText || "");
                const iconClass = pickFormationIcon(rawText);

                const idolIcon = document.createElement("span");
                idolIcon.className = "formation-idol-icon";
                idolIcon.innerHTML = `<i class="fas ${iconClass}"></i>`;
                titleClone.prepend(idolIcon);

                headerDiv.appendChild(titleClone);

                const arrow = document.createElement("i");
                arrow.className = "fas fa-chevron-down formation-arrow";
                headerDiv.appendChild(arrow);

                const contentDiv = document.createElement("div");
                contentDiv.className = "formation-content";

                group.innerHTML = "";
                group.appendChild(headerDiv);
                contentDiv.appendChild(gridEl);
                group.appendChild(contentDiv);

                headerDiv.onclick = () => { group.classList.toggle("open"); };
            }
        });

        const navBtns = contentBox.querySelectorAll(".modal-nav-btn");
        navBtns.forEach((btn) => {
            btn.onclick = function () {
                navBtns.forEach((b) => b.classList.remove("active"));
                contentBox.querySelectorAll(".modal-section").forEach((s) => s.classList.remove("active"));
                this.classList.add("active");
                const target = this.getAttribute("data-section");
                const section = contentBox.querySelector(`.modal-section[data-section="${target}"]`);
                if (section) section.classList.add("active");
            };
        });
        document.getElementById("disco-modal").classList.add("active");
    }

    function setMemberFilter(type, btn) {
      currentFilter = type;
      document.querySelectorAll(".filter-btn").forEach((b) => b.classList.remove("active"));
      if (btn) btn.classList.add("active");
      renderMembers();
    }

    function renderMembers() {
      const container = document.getElementById("members-container");
      const buttons = document.getElementById("scroll-buttons");
      container.innerHTML = ""; buttons.innerHTML = "";
      if (!loadedMembers.length) { container.innerHTML = '<p style="text-align:center;color:#999">Vazio.</p>'; return; }
      const EX_STATUSES = new Set(["graduada", "demitida", "expulsa"]);
      const groups = {}; const exMembers = [];
      loadedMembers.forEach((r) => {
        const status = (r.Status || "").trim().toLowerCase();
        if (EX_STATUSES.has(status)) exMembers.push(r);
        else {
          const key = currentFilter === "team" ? (r.Time || "Sem Time") : (r.Geracao || "Outros");
          if (!groups[key]) groups[key] = [];
          groups[key].push(r);
        }
      });
      function makeCard(m) {
        const payload = encodeURIComponent(JSON.stringify({ name: m.Nome, team: m.Time, gen: m.Geracao, photo: getImgUrl(m.Foto), bio: m.Perfil, gallery: getGalleryUrls(m.Galeria), part: m.Participacoes, status: m.Status })).replace(/'/g, "%27");
        return `<div class="member-card" onclick="openMember('${payload}')"><div class="member-photo-container"><img src="${getImgUrl(m.Foto)}" loading="lazy" onerror="this.src='https://placehold.co/600x600?text=?'"></div><div class="member-info-box"><div class="member-name-text">${m.Nome}</div><div class="member-team-text">${m.Time}</div></div></div>`;
      }
      let sortedKeys = Object.keys(groups).sort();
      if (currentFilter === "team") { const order = ["Team C", "Team T", "Team L", "Team Kenkyuusei"]; sortedKeys = sortedKeys.sort((a, b) => order.indexOf(a) - order.indexOf(b)); }
      sortedKeys.forEach((key, idx) => {
        const btnId = `group-${idx}`;
        buttons.innerHTML += `<button class="button-gen" onclick="document.getElementById('${btnId}').scrollIntoView({behavior:'smooth', block:'start'})">${key}</button>`;
        let html = ""; groups[key].forEach((m) => (html += makeCard(m)));
        container.innerHTML += `<div id="${btnId}" class="generation-group"><h3 class="generation-title">${key}</h3><div class="member-grid-layout">${html}</div></div>`;
      });
      if (exMembers.length) {
        const exId = "gen-ex"; buttons.innerHTML += `<button class="button-gen" onclick="document.getElementById('${exId}').scrollIntoView({behavior:'smooth', block:'start'})">Ex-membros</button>`;
        let exHtml = ""; exMembers.sort((a, b) => (a.Nome||"").localeCompare(b.Nome||"")).forEach((m) => (exHtml += makeCard(m)));
        container.innerHTML += `<div id="${exId}" class="generation-group"><h3 class="generation-title">Ex-membros</h3><div class="member-grid-layout">${exHtml}</div></div>`;
      }
      const btns = document.querySelectorAll(".button-gen");
      if (btns.length > 0) btns[0].classList.add("active");
      btns.forEach((b) => {
        b.onclick = function () {
          btns.forEach((x) => x.classList.remove("active"));
          this.classList.add("active");
          const targetId = this.getAttribute("onclick").match(/'([^']+)'/)[1];
          document.getElementById(targetId).scrollIntoView({ behavior: "smooth", block: "start" });
        };
      });
    }

    function openMember(json) {
        const data = JSON.parse(decodeURIComponent(json));
        document.getElementById("m-cover").src = data.photo || "";
        document.getElementById("m-name").innerText = data.name || "";
        document.getElementById("m-team").innerText = `${data.team || ""} • ${data.gen || ""}${data.status === "Graduada" ? " • Graduada" : ""}`;
        document.getElementById("m-bio").innerText = data.bio || "Sem biografia.";
        
        const gal = document.getElementById("m-gallery"); gal.innerHTML = "";
        (data.gallery || []).forEach(url => gal.innerHTML += `<img src="${resolveImage(url)}" loading="lazy">`);
        if(!data.gallery?.length) gal.innerHTML = '<p style="grid-column:1/-1;color:#999;text-align:center;">Sem fotos.</p>';
        
        const partContainer = document.getElementById("m-part"); partContainer.innerHTML = "";
        
        // MAPA DE ÍCONES ATUALIZADO (com A-side e B-side)
        const iconMap = {
            "a-side": "fa-star",
            "aside": "fa-star",
            "b-side": "fa-compact-disc",
            "bside": "fa-compact-disc",
            "senbatsu": "fa-crown",      
            "solo": "fa-microphone",     
            "undergirls": "fa-layer-group",
            "center": "fa-star",          
            "unit": "fa-users"            
        };

        try {
            if (data.part) {
                let participations = typeof data.part === "string" ? JSON.parse(data.part) : data.part;
                if (!Array.isArray(participations) || !participations.length) throw "Vazio";
                
                // Ordena as participações pelo ID da discografia (CRESCENTE: 1, 2, 3...)
                participations.sort((a, b) => {
                  const ao = getDiscographyIdForParticipation(a);
                  const bo = getDiscographyIdForParticipation(b);
                  if (ao !== bo) return ao - bo;
                  return String(a.single||"").localeCompare(String(b.single||""), "pt-BR");
                });

                participations.forEach(p => {
                    let tracksHtml = "";
                    const tracks = Array.isArray(p.tracks) ? p.tracks : [p.tracks];
                    
                    tracks.forEach(t => {
                        const lbls = (t.labels||[]).map(l => {
                            // Normaliza o label (lowercase, trim, espaço vira hifen)
                            const slug = String(l).toLowerCase().trim().replace(/\s+/g, "-");
                            // Tenta achar icone pelo slug normalizado (ex: a-side) ou pelo slug original
                            const iconClass = iconMap[slug] ? `<i class="fas ${iconMap[slug]}"></i>` : "";
                            return `<span class="label ${slug}">${iconClass} ${l}</span>`;
                        }).join('');
                        
                        const unitBadge = t.unitName ? `<span class="label unit"><i class="fas fa-users"></i> ${t.unitName}</span>` : "";

                        tracksHtml += `<li><span class="song-name">${t.title || "Música"}</span><div class="song-badges">${unitBadge}${lbls}</div></li>`;
                    });
                    partContainer.innerHTML += `<div class="part-card"><div class="part-header">${p.single || "Single"}</div><ul class="part-list">${tracksHtml}</ul></div>`;
                });
            } else throw "Vazio";
        } catch (e) { partContainer.innerHTML = '<p style="color:#999;text-align:center;margin-top:20px;">Nenhuma participação encontrada.</p>'; }
        
        tab("perfil", document.querySelector(".tab-btn"));
        document.getElementById("member-modal").classList.add("active");
    }

    function closeModal(id) { document.getElementById(id).classList.remove("active"); }
    function tab(t, el) {
      document.querySelectorAll(".tab-btn").forEach((b) => b.classList.remove("active")); el.classList.add("active");
      document.querySelectorAll(".tab-content").forEach((c) => c.classList.remove("active")); document.getElementById("tab-" + t).classList.add("active");
    }
    document.addEventListener("click", (e) => { if (e.target.classList.contains("modal-overlay")) e.target.classList.remove("active"); });
    init();
  </script>
</body>
</html>
